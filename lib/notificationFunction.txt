// supabase/functions/task-notification/index.ts
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import {JWT} from 'npm:google-auth-library@9'

// interface Task {
//   id: string,
//   user_id: string,
//   nombre: string,
//   descripcion: string,
// }

// interface WebhookPayload {
//   type: 'INSERT'
//   table: string
//   record: task
//   schema: 'public',
//   old_record: null | Task
// }

const supabase = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

Deno.serve(async () => {

  // const { data } = await supabase.from('PROFILES')
  //   .select('fcm_token')
  //   .eq('id', payload.record.profile_id)
  //   .single()
  
  // const fcmToken = data!.fcm_token as string

  // const res = await fetch(
  //   `https://fcm.googleapis.com/v1/projects/${project_id}/messages:send`,
  // ) {
  //   method: 'POST',
  //   headers: {
  //     'Content-Type': 'aplication/json'
  //     Authorization: `Bearer ${accessToken}`,
  //   },
  //   body: Json.stringify({
  //     message: fcmToken,
  //     notification{
  //       title: ``
  //     }
  //   })
  // }

  // const FCM_SERVER_KEY = Deno.env.get("FCM_SERVER_KEY")!;

  const today = new Date().toISOString().slice(0, 10);

  const { data: tareas, error: errorTareas } = await supabase
    .from("TAREAS")
    .select("id,nombre,descripcion,user_id")
    .eq("fechaFinalizacion", today);

  if (errorTareas) {
    return new Response(JSON.stringify(errorTareas), { status: 500 });
  }

  if (!tareas || tareas.length == 0) {
    return new Response(JSON.stringify({ message: "No hay tareas para hoy" }));
  }

  const {default: serviceAccount} = await import('../service-account.json', {
    with: {type: 'json'}
  })

  const accessToken = getAccessToken({
    clientEmail: serviceAccount.client_email,
    privateKey: serviceAccount.private_key
  })

  for (const tarea of tareas) {
    const { data: profile } = await supabase
      .from("PROFILES")
      .select("fcm_token")
      .eq("id", tarea.user_id)
      .single();

    if (!profile?.fcm_token) continue;

    await fetch(`https://fcm.googleapis.com/v1/projects/${project_id}/messages:send`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        token: profile.fcm_token,
        notification: {
          title: "ðŸ“… Recordatorio",
          body: `Tienes una tarea pendiente para hoy: ${tarea.nombre}`
        }
      })
    });
  }

  return new Response(JSON.stringify({ status: "OK", notified: tareas.length }));
});


const getAccessToken = ({
  clientEmail,
  privateKey
}: {
  clientEmail: string,
  privateKey: string
}): Promise<string> => {
  return new Promise((resolve, reject) => {
    const jwtClient = new JWT({
      email: clientEmail,
      key: privateKey,
      scopes: ['https://www.googleapis.com/auth/firebase.messaging'],
    })
    jwtClient.authorized((err, tokens) => {
      if (err) {
        reject(err)
        return;
      }
      resolve(tokens!.access_token!)
    })
  })
}
